name: "CodeQL Security Scan"

########################################################################
# ─── REQUIRED PERMISSIONS ──────────────────────────────────────────────
# Public repositories get free CodeQL scanning, but you still need
# to give the GITHUB_TOKEN the right scopes for uploading results.
permissions:
  contents: read          # needed to check out code
  security-events: write  # needed to upload SARIF/code-scanning results
########################################################################

# ─── WHEN TO RUN ───────────────────────────────────────────────────────
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  codeql-analysis:
    name: Analyze with CodeQL
    runs-on: ubuntu-latest

    strategy:
      matrix:
        language: [ 'python' ]

    steps:
      # 1) Check out your code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2) Initialize CodeQL (now using @v3)
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          # (You can add `queries: ./my-custom-queries` here if you ever write your own .ql packs.)

      # 3) (Optional) Install dependencies so CodeQL can fully resolve imports.
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # 4) (No build step needed for a pure-Python repo; adjust if you do have build steps.)
      - name: No-op build step
        run: echo "Nothing to build for pure‐Python repository."

      # 5) Run CodeQL analysis (using @v3). If there are zero .py files, this can fail with exit code 32.
      #    We use `continue-on-error: true` so that an empty repo (README only) does not break the entire workflow.
      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v3
        continue-on-error: true

      # (You could add more steps here, e.g. uploading custom SARIF or notifying Slack, etc.)
